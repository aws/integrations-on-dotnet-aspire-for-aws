@page "/secrets-demo"
@using Amazon.SecretsManager
@using Amazon.SecretsManager.Model
@inject IConfiguration Configuration
@inject IAmazonSecretsManager SecretsManagerClient

<PageTitle>Secrets Manager Demo</PageTitle>

<h1>AWS Secrets Manager Integration</h1>

<p>
This page demonstrates integration with AWS Secrets Manager in .NET Aspire applications.
</p>

<h3>Configuration from AppHost</h3>
<ul>
    @foreach(var item in Configuration.GetSection("Secrets").AsEnumerable())
    {
        @if(item.Value != null)
        {
            <li><b>@item.Key:</b> @MaskValue(item.Key, item.Value)</li>
        }
    }
</ul>

@if (!string.IsNullOrEmpty(apiSecretArn))
{
    <h3>Direct Environment Variable</h3>
    <p><b>API_SECRET_ARN:</b> @apiSecretArn</p>

    <button class="btn btn-primary" @onclick="RetrieveSecretValue">Retrieve Secret Metadata</button>

    @if (!string.IsNullOrEmpty(secretMetadata))
    {
        <div class="alert alert-info mt-3">
            <h4>Secret Metadata</h4>
            <pre>@secretMetadata</pre>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">
            <strong>Error:</strong> @errorMessage
        </div>
    }
}

@code {
    private string? apiSecretArn;
    private string? secretMetadata;
    private string? errorMessage;

    protected override void OnInitialized()
    {
        apiSecretArn = Environment.GetEnvironmentVariable("API_SECRET_ARN");
    }

    private string MaskValue(string key, string value)
    {
        if (key.Contains("Arn", StringComparison.OrdinalIgnoreCase))
        {
            return value;
        }
        return "********";
    }

    private async Task RetrieveSecretValue()
    {
        try
        {
            errorMessage = null;
            secretMetadata = null;

            if (string.IsNullOrEmpty(apiSecretArn))
            {
                errorMessage = "API_SECRET_ARN not configured";
                return;
            }

            var request = new DescribeSecretRequest
            {
                SecretId = apiSecretArn
            };

            var response = await SecretsManagerClient.DescribeSecretAsync(request);

            secretMetadata = $@"Name: {response.Name}
ARN: {response.ARN}
Description: {response.Description ?? "N/A"}
Created: {response.CreatedDate:yyyy-MM-dd HH:mm:ss}
Last Changed: {response.LastChangedDate:yyyy-MM-dd HH:mm:ss}
Last Accessed: {response.LastAccessedDate:yyyy-MM-dd HH:mm:ss}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to retrieve secret: {ex.Message}";
        }
    }
}
